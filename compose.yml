services:
  localstack:
    image: localstack/localstack:4.3.0
    ports:
      - "${LOCALSTACK_PORT:-4566}:4566"
    env_file:
      - "compose/aws.env"
    environment:
      DEBUG: ${DEBUG:-1}
      LS_LOG: WARN
      SERVICES: sqs,sns
      LOCALSTACK_HOST: 127.0.0.1
    volumes:
      - ${TMPDIR:-/tmp}/localstack:/var/lib/localstack
      - ./compose/start-localstack.sh:/etc/localstack/init/ready.d/start-localstack.sh
    networks:
      - cdp-tenant

  mongodb:
    image: mongo:6.0.13
    networks:
      - cdp-tenant
    ports:
      - "${MONGO_PORT:-27017}:27017"
    volumes:
      - mongodb-data:/data
    restart: always

  entra:
    image: defradigital/fg-entra-stub-frontend:0.11.0
    ports:
      - "${ENTRA_PORT:-3010}:3010"
    networks:
      - cdp-tenant

  fg-cw-backend:
    build: .
    ports:
      - "${CW_PORT:-3001}:3001"
    links:
      - "localstack:localstack"
      - "mongodb:mongodb"
      - "entra:entra"
    depends_on:
      localstack:
        condition: service_healthy
      mongodb:
        condition: service_started
      entra:
        condition: service_started
    environment:
      # Use environment variables instead of .env file to allow test overrides
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3001
      MONGO_URI: mongodb://mongodb:27017/
      AWS_REGION: ${AWS_REGION:-eu-west-2}
      AWS_ENDPOINT_URL: ${AWS_ENDPOINT_URL:-http://localstack:4566}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-test}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-test}
      CREATE_NEW_CASE_SQS_URL: ${CREATE_NEW_CASE_SQS_URL:-http://sqs.eu-west-2.127.0.0.1:4566/000000000000/create_new_case}
      # OIDC settings - use service name for container-to-container communication
      OIDC_JWKS_URI: ${OIDC_JWKS_URI:-https://login.microsoftonline.com/common/discovery/v2.0/keys}
      OIDC_VERIFY_ISS: ${OIDC_VERIFY_ISS:-https://sts.windows.net/common/}
      OIDC_VERIFY_AUD: ${OIDC_VERIFY_AUD:-api://client-id}
    networks:
      - cdp-tenant
    develop:
      watch:
        - path: src/
          target: /home/node/src
          action: sync+restart
    volumes:
      - ./migrate-mongo-config.js:/home/node/migrate-mongo-config.js
      - ./migrations:/home/node/migrations
      - ./package.json:/home/node/package.json

volumes:
  mongodb-data:

networks:
  cdp-tenant:
    driver: bridge
    name: cdp-tenant
